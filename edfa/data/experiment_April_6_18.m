%% Pin average = -13 dBm
Data13 = [1530.7064	-16.082	12.677	-42.773	11.272	-44.117	8.988	-46.152	7.104	-47.62	4.605	-49.487	0.271	-52.02
1531.4783	-16.52	13.2	-42.49	11.695	-43.857	9.09	-46.049	7.245	-47.51	4.9	-49.321	0.86	-51.681
1532.2466	-16.337	13.132	-42.355	11.628	-43.776	9.082	-45.977	7.263	-47.442	4.912	-49.188	0.848	-51.587
1533.0405	-16.429	13.173	-42.422	11.596	-43.868	9.003	-46.052	7.293	-47.417	5.05	-49.057	1.135	-51.359
1533.8762	-16.333	12.812	-42.682	11.366	-44.12	8.996	-46.206	7.435	-47.469	5.253	-48.993	1.504	-51.216
1534.6516	-16.338	12.437	-43.014	10.912	-44.445	8.668	-46.33	7.248	-47.472	5.233	-48.972	1.766	-51.128
1535.4272	-16.276	11.89	-43.399	10.457	-44.714	8.639	-46.434	7.3	-47.506	5.412	-48.954	2.07	-50.975
1536.2255	-16.208	11.838	-43.735	10.524	-44.929	8.711	-46.485	7.504	-47.515	5.591	-48.903	2.525	-50.921
1537.0186	-16.309	11.658	-43.928	10.622	-45.064	8.832	-46.548	7.754	-47.484	5.994	-48.813	2.969	-50.81
1537.7784	-16.379	11.739	-44.047	10.656	-45.098	9.066	-46.503	7.829	-47.434	6.183	-48.725	3.265	-50.66
1538.5699	-16.257	11.647	-44.055	10.615	-45.052	9.034	-46.397	7.981	-47.317	6.211	-48.597	3.39	-50.563
1539.4133	-16.27	11.854	-43.956	10.769	-44.934	9.319	-46.242	8.274	-47.2	6.491	-48.45	3.707	-50.349
1540.1835	-16.181	11.987	-43.811	10.928	-44.765	9.446	-46.065	8.34	-46.981	6.756	-48.268	4	-50.183
1541.0446	-16.303	12.371	-43.617	11.36	-44.543	9.851	-45.85	8.764	-46.772	7.183	-48.048	4.385	-49.956
1541.7276	-16.276	12.657	-43.446	11.657	-44.373	10.131	-45.678	9.083	-46.594	7.448	-47.867	4.698	-49.772
1542.5674	-16.313	12.738	-43.277	11.824	-44.202	10.313	-45.526	9.213	-46.417	7.603	-47.695	4.954	-49.592
1543.3307	-16.211	13.028	-43.153	12.079	-44.053	10.609	-45.361	9.522	-46.269	7.91	-47.545	5.232	-49.443
1544.1311	-16.334	13.215	-43.035	12.201	-43.92	10.806	-45.249	9.638	-46.113	8.22	-47.386	5.538	-49.286
1544.9005	-16.173	13.42	-42.944	12.401	-43.827	11.054	-45.134	9.894	-46.04	8.371	-47.273	5.692	-49.115
1545.7038	-16.059	13.269	-42.89	12.244	-43.758	10.928	-45.044	9.913	-45.921	8.306	-47.149	5.713	-49.037
1546.5292	-16.292	13.439	-42.857	12.473	-43.714	11.137	-44.99	10.07	-45.843	8.558	-47.05	5.995	-48.903
1547.3458	-16.075	13.533	-42.805	12.567	-43.655	11.226	-44.876	10.07	-45.728	8.625	-46.971	6.136	-48.812
1548.1174	-16.162	13.501	-42.761	12.646	-43.605	11.337	-44.825	10.257	-45.687	8.8	-46.886	6.319	-48.724
1548.9361	-16.184	13.771	-42.739	12.851	-43.569	11.478	-44.775	10.581	-45.609	9.025	-46.771	6.485	-48.594
1549.7083	-16.08	13.745	-42.736	12.868	-43.522	11.574	-44.708	10.555	-45.564	9.189	-46.686	6.751	-48.521
1550.5284	-16.061	13.848	-42.679	12.913	-43.473	11.622	-44.642	10.724	-45.463	9.4	-46.613	6.961	-48.423
1551.307	-16.165	13.809	-42.628	12.989	-43.411	11.659	-44.563	10.816	-45.363	9.419	-46.507	7.122	-48.294
1552.1676	-16.31	14.299	-42.568	13.43	-43.344	12.037	-44.486	11.052	-45.294	9.677	-46.41	7.438	-48.181
1552.9396	-16.229	13.951	-42.505	13.202	-43.262	11.938	-44.375	11.069	-45.188	9.651	-46.31	7.427	-48.067
1553.7329	-16.17	14.09	-42.434	13.264	-43.207	12.049	-44.308	11.249	-45.095	10.021	-46.202	7.698	-47.925
1554.5294	-16.216	14.113	-42.36	13.407	-43.121	12.193	-44.211	11.386	-45.022	10.079	-46.104	7.851	-47.84
1555.3188	-16.112	14.179	-42.331	13.499	-43.066	12.287	-44.139	11.399	-44.914	10.096	-46.026	7.933	-47.763
1556.164	-16.069	14.45	-42.308	13.708	-43.036	12.556	-44.1	11.661	-44.866	10.354	-45.973	8.229	-47.698
1556.9722	-16.168	14.336	-42.28	13.69	-43.009	12.477	-44.051	11.658	-44.802	10.368	-45.884	8.251	-47.574
1557.7694	-16.287	14.439	-42.27	13.708	-42.956	12.558	-44.02	11.75	-44.749	10.5	-45.843	8.41	-47.531
1558.6172	-16.268	14.429	-42.345	13.701	-43.026	12.666	-44.058	11.786	-44.785	10.585	-45.838	8.483	-47.509
1559.3979	-16.028	14.278	-42.409	13.684	-43.094	12.564	-44.096	11.814	-44.81	10.517	-45.84	8.484	-47.48
1560.1861	-16.008	14.254	-42.545	13.624	-43.188	12.489	-44.184	11.725	-44.873	10.534	-45.898	8.547	-47.532
1560.966	-16.121	14.127	-42.724	13.431	-43.362	12.473	-44.306	11.706	-44.995	10.519	-45.977	8.53	-47.571
1561.7886	-16.128	13.88	-42.936	13.29	-43.534	12.271	-44.465	11.542	-45.14	10.384	-46.105	8.499	-47.649];


%% Pin average = -16 dBm
Data16 = [1530.709	-18.953	15.623	-39.601	14.468	-40.845	12.418	-42.891	10.661	-44.571	8.109	-46.732	3.412	-50.085
1531.48	-19.179	15.856	-39.379	14.692	-40.689	12.361	-42.893	10.601	-44.521	8.132	-46.666	3.677	-49.892
1532.2495	-19.093	16.088	-39.312	14.766	-40.67	12.383	-42.999	10.638	-44.565	8.266	-46.586	4.047	-49.779
1533.0421	-19.193	16.485	-39.479	15.004	-40.9	12.507	-43.194	10.895	-44.678	8.616	-46.608	4.583	-49.585
1533.8868	-19.362	15.805	-39.911	14.419	-41.299	12.067	-43.488	10.77	-44.859	8.463	-46.643	4.889	-49.51
1534.6543	-19.167	14.825	-40.366	13.483	-41.753	11.399	-43.742	10.017	-45.019	8.096	-46.686	4.523	-49.364
1535.4305	-19.163	14.406	-40.866	13.173	-42.203	11.588	-43.971	10.18	-45.174	8.48	-46.775	5.083	-49.295
1536.229	-19.119	14.307	-41.333	13.081	-42.574	11.349	-44.164	10.211	-45.284	8.41	-46.841	5.22	-49.225
1537.0191	-19.186	14.084	-41.654	13.041	-42.803	11.427	-44.286	10.277	-45.349	8.52	-46.816	5.429	-49.189
1537.7828	-19.242	14.082	-41.842	12.972	-42.901	11.495	-44.291	10.355	-45.333	8.679	-46.777	5.76	-49.091
1538.5764	-19.209	13.794	-41.894	12.892	-42.878	11.435	-44.219	10.362	-45.249	8.799	-46.648	5.857	-48.933
1539.4108	-19.125	14.032	-41.828	13.043	-42.787	11.636	-44.101	10.621	-45.108	8.9	-46.524	6.151	-48.734
1540.1864	-19.197	14.223	-41.709	13.208	-42.656	11.865	-43.962	10.861	-44.941	9.228	-46.317	6.437	-48.569
1541.049	-19.33	14.428	-41.52	13.568	-42.434	12.2	-43.74	11.184	-44.723	9.632	-46.1	6.8	-48.351
1541.7318	-19.242	14.753	-41.356	13.865	-42.262	12.499	-43.562	11.488	-44.553	9.872	-45.95	7.087	-48.178
1542.572	-19.313	14.975	-41.205	14.039	-42.1	12.704	-43.415	11.648	-44.397	10.187	-45.763	7.311	-48.027
1543.3348	-19.251	15.178	-41.11	14.288	-41.991	12.976	-43.276	11.92	-44.267	10.352	-45.603	7.608	-47.841
1544.1263	-19.174	15.13	-41.001	14.208	-41.888	12.948	-43.181	11.919	-44.145	10.455	-45.483	7.67	-47.705
1544.9046	-19.145	15.5	-40.955	14.67	-41.823	13.304	-43.111	12.462	-44.048	10.717	-45.376	8.013	-47.594
1545.7079	-19.088	15.562	-40.92	14.52	-41.778	13.38	-43.056	12.133	-43.982	10.802	-45.286	8.055	-47.486
1546.5334	-19.249	15.673	-40.909	14.663	-41.739	13.312	-42.994	12.323	-43.928	10.992	-45.19	8.279	-47.368
1547.3532	-19.127	15.636	-40.88	14.806	-41.688	13.548	-42.931	12.469	-43.848	11.173	-45.123	8.466	-47.262
1548.1267	-19.172	15.531	-40.873	14.74	-41.681	13.574	-42.898	12.618	-43.782	11.234	-45.028	8.623	-47.169
1548.9527	-19.35	15.809	-40.881	15.008	-41.671	13.692	-42.864	12.845	-43.754	11.279	-44.973	9.059	-47.085
1549.7134	-19.128	15.653	-40.894	14.94	-41.668	13.68	-42.845	12.822	-43.706	11.483	-44.919	8.979	-46.997
1550.5436	-19.061	15.713	-40.861	14.979	-41.633	13.816	-42.774	12.815	-43.647	11.553	-44.848	9.01	-46.908
1551.3122	-19.205	15.783	-40.82	14.993	-41.583	13.807	-42.723	12.939	-43.579	11.622	-44.772	9.181	-46.813
1552.1702	-19.194	15.942	-40.806	15.004	-41.55	13.983	-42.654	13.07	-43.491	11.607	-44.676	9.292	-46.695
1552.9447	-19.219	15.849	-40.76	15.077	-41.491	13.942	-42.583	13.098	-43.403	11.857	-44.58	9.426	-46.59
1553.7386	-19.152	15.732	-40.692	15.118	-41.414	13.857	-42.499	13.118	-43.328	11.788	-44.475	9.596	-46.491
1554.527	-19.15	15.956	-40.643	15.228	-41.362	14.202	-42.427	13.324	-43.25	12.131	-44.401	9.821	-46.399
1555.3243	-19.072	16.04	-40.631	15.28	-41.335	14.226	-42.377	13.367	-43.184	12.164	-44.315	9.846	-46.287
1556.1691	-18.963	15.888	-40.616	15.215	-41.314	14.11	-42.343	13.344	-43.144	12.118	-44.263	9.817	-46.238
1556.9775	-19.296	16.246	-40.608	15.544	-41.307	14.514	-42.319	13.679	-43.097	12.485	-44.213	10.223	-46.154
1557.7739	-19.299	16.117	-40.632	15.521	-41.305	14.431	-42.327	13.625	-43.067	12.436	-44.195	10.241	-46.089
1558.6226	-19.277	16.049	-40.698	15.478	-41.347	14.454	-42.36	13.646	-43.116	12.475	-44.191	10.337	-46.078
1559.4039	-18.966	15.973	-40.825	15.331	-41.472	14.42	-42.457	13.57	-43.182	12.451	-44.266	10.318	-46.087
1560.1919	-19.007	15.883	-41	15.251	-41.636	14.268	-42.582	13.636	-43.289	12.414	-44.335	10.304	-46.152
1560.9717	-19.077	15.696	-41.19	15.126	-41.803	14.219	-42.724	13.447	-43.432	12.415	-44.454	10.323	-46.223
1561.7939	-19.133	15.493	-41.449	14.896	-42.048	14.053	-42.939	13.326	-43.608	12.245	-44.618	10.246	-46.344];

%% Pin average = -19 dBm
Data19 = [1530.7072	-21.824	18.092	-36.768	17.348	-37.714	15.533	-39.628	13.816	-41.364	11.314	-43.748	7.128	-47.463
1531.4786	-22.354	18.67	-36.583	17.586	-37.596	15.357	-39.778	13.753	-41.458	11.414	-43.725	7.518	-47.363
1532.2499	-21.992	18.22	-36.542	17.57	-37.634	15.186	-40.002	13.605	-41.625	11.407	-43.783	7.429	-47.267
1533.0407	-22.1	18.956	-36.658	17.484	-38.087	15.123	-40.343	13.524	-41.832	11.457	-43.892	7.653	-47.246
1533.8846	-22.105	18.092	-37.072	16.703	-38.556	14.443	-40.783	13.36	-42.143	11.314	-44.048	7.485	-47.199
1534.6516	-22.026	17.425	-37.573	15.874	-39.308	14.06	-41.163	12.84	-42.428	11.07	-44.188	7.641	-47.205
1535.4277	-22.124	17.079	-38.183	15.52	-39.824	14.217	-41.517	12.821	-42.688	11.037	-44.361	7.925	-47.242
1536.2251	-22.014	16.514	-38.866	15.267	-40.253	13.755	-41.803	12.598	-42.908	11.023	-44.501	7.887	-47.283
1537.0139	-22.07	16.07	-39.313	15.169	-40.566	13.561	-41.998	12.7	-43.056	11.024	-44.576	7.954	-47.219
1537.7676	-22.174	16.142	-39.618	15.11	-40.73	13.788	-42.074	12.676	-43.111	11.232	-44.562	8.344	-47.173
1538.5715	-22.208	15.67	-39.742	14.804	-40.762	13.78	-42.055	12.682	-43.062	11.267	-44.502	8.346	-47.034
1539.4066	-22.082	16.015	-39.744	15.034	-40.693	13.83	-41.936	12.978	-42.941	11.359	-44.382	8.633	-46.885
1540.1842	-22.219	16.138	-39.665	15.413	-40.572	14.123	-41.808	13.264	-42.808	11.659	-44.204	8.895	-46.705
1541.0446	-22.277	16.32	-39.464	15.448	-40.385	14.333	-41.618	13.43	-42.608	11.993	-44	9.176	-46.499
1541.7306	-22.158	16.572	-39.323	15.773	-40.232	14.671	-41.464	13.681	-42.446	12.161	-43.845	9.472	-46.333
1542.568	-22.148	16.703	-39.194	15.926	-40.059	14.788	-41.315	13.796	-42.293	12.349	-43.692	9.611	-46.128
1543.331	-22.189	17.046	-39.116	16.32	-39.99	15.148	-41.211	14.154	-42.177	12.695	-43.552	9.997	-45.985
1544.1221	-22.155	16.994	-39.029	16.245	-39.911	15.05	-41.125	14.142	-42.103	12.695	-43.463	10.031	-45.866
1544.9008	-22.164	17.53	-38.994	16.611	-39.853	15.397	-41.065	14.397	-42.03	13.058	-43.373	10.332	-45.776
1545.7039	-22.072	17.234	-39.002	16.852	-39.84	15.335	-41.038	14.629	-41.968	13.027	-43.307	10.389	-45.67
1546.5298	-22.214	17.562	-39.012	16.579	-39.858	15.54	-41.039	14.546	-41.951	13.193	-43.25	10.609	-45.578
1547.3454	-22.089	17.315	-39.014	16.665	-39.84	15.386	-41.012	14.62	-41.906	13.198	-43.209	10.764	-45.508
1548.1242	-22.191	17.378	-39.036	16.614	-39.827	15.527	-40.997	14.657	-41.867	13.394	-43.145	10.838	-45.413
1548.9455	-22.247	17.779	-39.07	16.868	-39.866	16.037	-40.987	14.945	-41.852	13.486	-43.114	10.851	-45.361
1549.7087	-22.063	17.351	-39.095	16.662	-39.886	15.586	-40.987	14.761	-41.86	13.438	-43.085	11.045	-45.285
1550.5293	-21.947	17.468	-39.101	16.666	-39.869	15.69	-40.958	14.7	-41.797	13.515	-43.02	11.088	-45.188
1551.3082	-22.098	17.262	-39.09	16.683	-39.842	15.612	-40.902	14.786	-41.745	13.594	-42.952	11.176	-45.111
1552.1645	-22.004	17.305	-39.081	16.344	-39.823	15.646	-40.869	14.825	-41.697	13.525	-42.88	11.175	-45.028
1552.9406	-22.11	17.334	-39.059	16.69	-39.78	15.664	-40.805	14.93	-41.63	13.727	-42.798	11.392	-44.924
1553.7427	-22.195	17.476	-39.001	17.259	-39.727	15.92	-40.742	15.21	-41.55	14.054	-42.707	11.565	-44.822
1554.5286	-22.145	17.461	-38.964	16.819	-39.686	15.937	-40.672	15.157	-41.479	13.954	-42.645	11.763	-44.734
1555.3197	-22.027	17.568	-38.965	16.968	-39.644	15.983	-40.639	15.248	-41.444	14.11	-42.581	11.881	-44.652
1556.1648	-21.965	17.538	-38.986	16.965	-39.674	16.056	-40.645	15.26	-41.413	14.084	-42.549	11.951	-44.59
1556.9734	-22.133	17.656	-38.999	17.137	-39.675	16.121	-40.624	15.364	-41.396	14.263	-42.524	12.109	-44.538
1557.7693	-22.171	17.498	-39.044	17	-39.678	16.016	-40.619	15.33	-41.383	14.186	-42.492	12.119	-44.51
1558.6181	-22.169	17.543	-39.146	16.965	-39.806	16.028	-40.723	15.293	-41.46	14.277	-42.54	12.165	-44.506
1559.3989	-21.981	17.413	-39.309	16.792	-39.937	15.938	-40.822	15.243	-41.544	14.139	-42.622	12.051	-44.561
1560.1875	-21.874	17.258	-39.501	16.792	-40.096	15.812	-40.974	15.167	-41.686	14.087	-42.743	12.117	-44.654
1560.9673	-21.951	17.009	-39.742	16.455	-40.286	15.685	-41.181	15.043	-41.873	13.941	-42.883	12.069	-44.741
1561.7893	-21.993	16.727	-40.032	16.253	-40.584	15.408	-41.43	14.777	-42.101	13.776	-43.095	11.846	-44.885];

%% Process
switch lower(experiment)
    case 'pin=-13dbm'
        Data = Data13;
        PpumpmW = [118.97, 90.3, 61.7, 47.4, 33.1, 18.79];
    case 'pin=-16dbm'
        Data = Data16;
        PpumpmW = [118.97, 90.3, 61.7, 47.4, 33.1, 18.79];
    case 'pin=-19dbm'
        Data = Data19;
        PpumpmW = [118.97, 90.3, 61.7, 47.4, 33.1, 18.79];
    otherwise 
        error('unknown experiment')
end

wavelength = Data(:, 1);
Pin = Data(:, 2);
experimental_GaindB = [Data(:, 3) Data(:, 5) Data(:, 7) Data(:, 9) Data(:, 11) Data(:, 13)];
experimental_PasedBm = [Data(:, 4) Data(:, 6) Data(:, 8) Data(:, 10) Data(:, 12) Data(:, 14)];
BWref = 12.5e9; % bandwdith of ASE measurement

%% Adjust losses from experiment
% Signal total power was measured at point A before the splice.  
SignalAttdB = 0.05 + 0.15 + 0.25; % Splice loss at A + Splice loss at B + Loss of WDM coupler
PumpAttdB = 0.15; % Splice loss at B
GainOffsetdB = 0.35; % Amount by which gain was underestimated dB
MeasurementLoss = 0.15 + 0.7 + 1.8; % Splice loss at C + Loss of switch + Loss at input to OSA 

Pin = Pin - SignalAttdB + 2.5 + 0.25;
PpumpmW = PpumpmW*10^(-PumpAttdB/10);
experimental_GaindB = experimental_GaindB + GainOffsetdB;
experimental_PasedBm = experimental_PasedBm + MeasurementLoss;